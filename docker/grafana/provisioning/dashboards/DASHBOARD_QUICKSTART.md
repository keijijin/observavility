# Grafana ダッシュボード クイックスタートガイド

## 🚀 5分でわかるダッシュボード監視

このガイドでは、最小限の時間でダッシュボードを使った監視を始められます。

---

## ステップ1: Grafanaにアクセス 📊

### ローカル環境
```
URL: http://localhost:3000
ユーザー名: admin
パスワード: admin
```

### OpenShift環境
```bash
# Grafana URLを取得
oc get route grafana -o jsonpath='{.spec.host}'

# ブラウザで開く
https://<上記で取得したURL>
```

---

## ステップ2: ダッシュボードを開く

1. 左メニューから **「Dashboards」** をクリック
2. **「Camel + Kafka + SpringBoot 分散アプリケーション ダッシュボード」** を選択

---

## ステップ3: 重要な4つのパネルを確認 ⭐

### 1. ⭐ リクエストキューサイズ（Undertow Webサーバーセクション）

```
🟢 0      = 正常（すべてのリクエストが即座に処理）
🟡 1-10   = 軽微な遅延
🟠 10-50  = キューイング発生
🔴 ≥ 50   = 深刻なボトルネック → 即座に対応！
```

**このパネルを最優先で確認してください！**

### 2. ❌ エラー率（Camelルートセクション）

```
🟢 < 1%   = 優秀
🟡 1-5%   = 許容範囲
🟠 5-10%  = 要改善
🔴 ≥ 10%  = 深刻 → ログ確認！
```

### 3. 🧠 ヒープメモリ使用率（システム概要）

```
🟢 < 60%  = 正常
🟡 60-80% = 注意
🟠 80-90% = 警告
🔴 ≥ 90%  = 危険（OOMリスク） → メモリ増加検討！
```

### 4. 📊 Consumer Lag（Kafkaメッセージングセクション）

```
🟢 < 100    = 正常
🟡 100-500  = 注意
🟠 500-1000 = 警告
🔴 ≥ 1000   = 深刻な遅延 → Consumer並列度増加！
```

---

## ステップ4: ダッシュボードの基本操作

### 時間範囲の変更
右上の **時計アイコン** をクリック
- おすすめ: **Last 15 minutes** または **Last 1 hour**

### 自動更新の設定
右上の **リフレッシュアイコン** をクリック
- デフォルト: 5秒（そのままでOK）

### グラフの拡大
パネルタイトルをクリック → **View** を選択

### データの絞り込み
グラフの凡例をクリックして表示/非表示を切り替え

---

## 💡 シーン別の使い方

### シーン1: 日常の健全性チェック（5分）

**確認順序:**
1. ⭐ リクエストキューサイズ → 0 であること
2. ❌ エラー率 → < 1% であること
3. 🧠 ヒープメモリ使用率 → < 60% であること
4. 📊 Consumer Lag → < 100 であること

**すべて🟢なら健全です！**

---

### シーン2: パフォーマンステスト中（リアルタイム監視）

**監視パネル:**
1. **📨 メッセージ処理レート** - 処理が進んでいるか
2. **⏰ HTTPレスポンスタイム** - 遅延が発生していないか
3. **🧵 ワーカースレッド状態** - Busyが増加しているか
4. **📊 スレッド使用率** - 80%を超えていないか

**手順:**
```bash
# テスト開始前にGrafanaを開く
# 時間範囲: Last 5 minutes
# 自動更新: 5秒

# ストレステストを実行
cd demo/openshift
./stress_test_advanced.sh -m preset -p medium

# Grafanaで上記4パネルをリアルタイム監視
```

---

### シーン3: 障害発生時のトラブルシューティング

**Step 1: 問題の特定（1分）**
1. ❌ エラー率 → 上昇しているか？
2. ⭐ リクエストキューサイズ → 溜まっているか？
3. 📊 Consumer Lag → 増加しているか？
4. ⚠️ GCオーバーヘッド率 → 高いか？

**Step 2: 時間範囲の調整**
- 問題発生時刻を含む範囲に設定
- 自動更新を一時停止

**Step 3: 詳細確認**

**エラー率が高い場合:**
```bash
# ログをLokiで確認
1. Grafana左メニュー → Explore
2. データソース: Loki
3. クエリ: {app="camel-observability-demo"} |= "ERROR"
```

**リクエストキューが溜まっている場合:**
```bash
# ワーカースレッド状態を確認
→ Busy が多い場合: スレッド数増加が必要

# スケールアウト
oc scale deployment/camel-app --replicas=3
```

**Consumer Lagが増加している場合:**
```bash
# Kafkaログを確認
oc logs -l app=kafka --tail=100

# Consumer並列度を確認して調整
```

---

## 🎯 よくある問題と即座の対処

### 問題1: リクエストキューサイズが🔴赤（≥50）

**原因:** ワーカースレッド不足

**即座の対応:**
```bash
# OpenShift: レプリカ数増加
oc scale deployment/camel-app --replicas=3

# 確認
watch "oc get pods | grep camel-app"
```

**恒久対策:** ワーカースレッド数を設定で増加

---

### 問題2: エラー率が🔴赤（≥10%）

**原因:** アプリケーションエラー、外部サービス障害

**即座の対応:**
```bash
# ログ確認
oc logs -l app=camel-app --tail=100 | grep ERROR

# Grafana Lokiで確認
# Explore → {app="camel-observability-demo"} |= "ERROR"
```

**恒久対策:** エラーの根本原因を修正

---

### 問題3: ヒープメモリが🔴赤（≥90%）

**原因:** メモリリーク、ヒープサイズ不足

**即座の対応:**
```bash
# メモリ増加
oc set resources deployment/camel-app \
  --limits=memory=2Gi \
  --requests=memory=1Gi

# 確認
oc rollout status deployment/camel-app
```

**恒久対策:** メモリリーク調査、ヒープダンプ分析

---

### 問題4: Consumer Lagが🔴赤（≥1000）

**原因:** Consumer処理が遅い、Kafka障害

**即座の対応:**
```bash
# Kafka状態確認
oc get pods | grep kafka

# レプリカ数増加（Consumer並列度向上）
oc scale deployment/camel-app --replicas=5
```

**恒久対策:** 処理の最適化、パーティション数増加

---

## 📱 モバイル/タブレットでの監視

Grafanaはモバイルブラウザでも表示可能：
1. 主要4パネルは小画面でも見やすい
2. アラート通知はメール/Slackで受け取れる
3. 外出先からでも健全性チェック可能

---

## 🔔 アラート設定（推奨）

**クリティカルアラート（即座に通知）:**
```
- リクエストキューサイズ ≥ 100
- エラー率 ≥ 10%
- ヒープメモリ使用率 ≥ 90%
```

設定方法は [ALERTING_GUIDE.md](../../ALERTING_GUIDE.md) を参照

---

## 🎓 さらに詳しく学ぶ

### 全パネルの詳細
→ [DASHBOARD_README.md](DASHBOARD_README.md)

### セクション別ガイド
1. **システム概要** - CPU、メモリ、スレッド
2. **Camelルート** - メッセージ処理、エラー
3. **HTTP** - リクエスト、レスポンス
4. **JVM** - GC、ヒープ、メモリ割り当て
5. **Undertow** - キュー、スレッド、接続
6. **Kafka** - Lag、レート、レイテンシ
7. **メッセージフロー** - エンドツーエンド可視化

### トラブルシューティング
→ [LOKI_TROUBLESHOOTING.md](../../LOKI_TROUBLESHOOTING.md) - ログ調査
→ [TEMPO_TROUBLESHOOTING.md](../../TEMPO_TROUBLESHOOTING.md) - トレース分析

---

## ✅ クイックチェックリスト

健全なシステムの確認項目：

- [ ] ⭐ リクエストキューサイズ = 0
- [ ] ❌ エラー率 < 1%
- [ ] 🧠 ヒープメモリ使用率 < 60%
- [ ] 💻 CPU使用率 < 50%
- [ ] 📊 Consumer Lag < 100
- [ ] 🧵 スレッド使用率 < 60%
- [ ] ⚠️ GCオーバーヘッド < 5%
- [ ] 📨 メッセージ処理レート > 0 (トラフィックがある場合)

**すべて✅なら完璧です！** 🎉

---

## 🆘 ヘルプが必要な場合

1. **詳細ドキュメント:** [DASHBOARD_README.md](DASHBOARD_README.md)
2. **Grafana公式ドキュメント:** https://grafana.com/docs/
3. **コミュニティフォーラム:** https://community.grafana.com/

---

このクイックスタートガイドで、すぐにダッシュボード監視を始められます！

何か問題があれば、まず **⭐ リクエストキューサイズ** と **❌ エラー率** を確認してください。

