# OpenShift 高度なストレステストガイド

## 概要

`stress_test_advanced.sh` は、より柔軟で詳細なストレステストを実行できる高度なスクリプトです。

### 主な機能

1. **🚀 段階的負荷増加（ランプアップ）** - 徐々に負荷を上げてボトルネックを発見
2. **📊 複数設定の連続テスト** - 異なる並列数で連続実行して比較
3. **⚡ プリセット設定** - すぐに使える4つのテストシナリオ
4. **📈 結果比較** - 複数テスト結果を自動比較
5. **💾 CSV出力** - Excelで分析可能な形式で結果を保存

---

## クイックスタート

### 1. 単一テスト（既存のstress_test.shと同じ）

```bash
cd demo/openshift
./stress_test_advanced.sh -m single -c 20 -d 60
```

**結果:**
- 20並列で60秒間テスト
- 単一の結果レポート

---

### 2. ランプアップテスト（推奨）

段階的に負荷を増やして、システムの限界を見つけます。

```bash
# 5並列から50並列まで、5ずつ増加、各30秒
./stress_test_advanced.sh -m rampup -s 5 -e 50 -i 5 -d 30
```

**実行されるテスト:**
- 5並列 → 30秒
- 10並列 → 30秒
- 15並列 → 30秒
- 20並列 → 30秒
- 25並列 → 30秒
- 30並列 → 30秒
- 35並列 → 30秒
- 40並列 → 30秒
- 45並列 → 30秒
- 50並列 → 30秒

**メリット:**
- パフォーマンスの変化を段階的に観察
- ボトルネックが発生する並列数を特定
- システムの限界を安全に確認

---

### 3. 複数設定テスト

特定の並列数で集中的にテストします。

```bash
# 10, 20, 50, 100並列で各60秒
./stress_test_advanced.sh -m multi -l "10,20,50,100" -d 60
```

**実行されるテスト:**
- 10並列 → 60秒
- 20並列 → 60秒
- 50並列 → 60秒
- 100並列 → 60秒

**メリット:**
- 特定のシナリオを比較
- スケーリングの効果を測定

---

### 4. プリセットテスト（最も簡単）

```bash
# 軽負荷テスト
./stress_test_advanced.sh -m preset -p light

# 中負荷テスト（推奨）
./stress_test_advanced.sh -m preset -p medium

# 高負荷テスト
./stress_test_advanced.sh -m preset -p heavy

# 極限ストレステスト
./stress_test_advanced.sh -m preset -p extreme
```

#### プリセット詳細

| プリセット | 並列数範囲 | ステップ | 各テスト時間 | 総テスト時間 |
|-----------|-----------|---------|------------|------------|
| light     | 5 → 20    | 5       | 30秒       | 約2分      |
| medium    | 10 → 50   | 10      | 60秒       | 約5分      |
| heavy     | 20 → 100  | 20      | 90秒       | 約6分      |
| extreme   | 50 → 200  | 50      | 120秒      | 約8分      |

---

## オプション一覧

### 基本オプション

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `-m, --mode <mode>` | テストモード（single/rampup/multi/preset） | single |
| `-d, --duration <seconds>` | 各テストの継続時間（秒） | 60 |
| `-w, --warmup <seconds>` | ウォームアップ時間（秒） | 5 |
| `-o, --output <file>` | 結果をCSVファイルに出力 | なし |
| `-h, --help` | ヘルプを表示 | - |

### Single Mode専用

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `-c, --concurrent <num>` | 並列接続数 | 10 |

### Rampup Mode専用

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `-s, --start <num>` | 開始並列数 | 5 |
| `-e, --end <num>` | 終了並列数 | 50 |
| `-i, --increment <num>` | 増加ステップ | 5 |

### Multi Mode専用

| オプション | 説明 | 例 |
|-----------|------|----|
| `-l, --list <nums>` | 並列数リスト（カンマ区切り） | "10,20,50" |

### Preset Mode専用

| オプション | 説明 | 選択肢 |
|-----------|------|--------|
| `-p, --preset <name>` | プリセット名 | light/medium/heavy/extreme |

---

## 実行例

### 例1: 基本的なランプアップテスト

```bash
./stress_test_advanced.sh -m rampup -s 10 -e 100 -i 10 -d 60
```

**説明:**
- 10並列から開始
- 100並列まで増加
- 10ずつ増やす（10, 20, 30, 40, 50, 60, 70, 80, 90, 100）
- 各テストは60秒

**所要時間:** 約10分（10回のテスト）

---

### 例2: 短時間で確認（クイックテスト）

```bash
./stress_test_advanced.sh -m rampup -s 5 -e 25 -i 5 -d 20 -w 3
```

**説明:**
- 5並列から25並列まで
- 5ずつ増やす
- 各テスト20秒
- ウォームアップ3秒

**所要時間:** 約2分

---

### 例3: 特定の並列数で詳細テスト

```bash
./stress_test_advanced.sh -m multi -l "10,25,50" -d 120
```

**説明:**
- 10, 25, 50並列でテスト
- 各テスト120秒（2分）
- より正確な結果を取得

**所要時間:** 約6分

---

### 例4: 結果をCSVに保存

```bash
./stress_test_advanced.sh -m rampup -s 10 -e 50 -i 10 -d 60 -o results.csv
```

**結果ファイル:** `results.csv`
```csv
Concurrent,Duration,TotalRequests,Success,Errors,ErrorRate,Throughput,AvgTime,MinTime,MaxTime,P95,P99
10,60,1234,1234,0,0.00,20.57,48.23,12,234,98,156
20,60,2145,2145,0,0.00,35.75,55.89,15,312,145,245
30,60,2834,2830,4,0.14,47.23,63.12,18,456,189,312
40,60,3201,3187,14,0.44,53.35,75.34,21,678,234,456
50,60,3456,3398,58,1.68,57.60,86.45,25,892,312,589
```

このCSVファイルをExcelやGoogleスプレッドシートで開いて、グラフ化できます。

---

## 結果の見方

### コンソール出力

各テスト後に以下が表示されます：

```
=== テスト結果 ===
並列数:             20
継続時間:           60 秒
総リクエスト数:     2145
成功:               2145
失敗:               0
エラー率:           0.00%
スループット:       35.75 req/sec
平均レスポンス:     55.89 ms
最小レスポンス:     15 ms
最大レスポンス:     312 ms
95パーセンタイル:  145 ms
99パーセンタイル:  245 ms
```

### 最終サマリー

すべてのテスト完了後、比較表が表示されます：

```
=== すべてのテスト結果 ===

並列数       リクエスト    成功率       エラー率     RPS          平均応答時間
--------------------------------------------------------------------------------
10          1234        100.00%      0.00%        20.57        48.23ms
20          2145        100.00%      0.00%        35.75        55.89ms
30          2830        99.86%       0.14%        47.23        63.12ms
40          3187        99.56%       0.44%        53.35        75.34ms
50          3398        98.32%       1.68%        57.60        86.45ms
```

### 最適な設定の提案

スクリプトが自動的に最適な並列数を提案します：

```
✅ 最適な並列数: 40 (スループット: 53.35 req/sec)
```

**基準:**
- エラー率が5%未満
- スループットが最大

---

## パフォーマンス指標の評価基準

### エラー率

| エラー率 | 評価 | 説明 |
|---------|------|------|
| < 1% | ✅ 優秀 | 本番環境で問題なし |
| 1% - 5% | ⚠️ 許容範囲 | 監視が必要 |
| > 5% | ❌ 高い | 改善が必要 |

### 平均レスポンスタイム

| レスポンスタイム | 評価 | 説明 |
|----------------|------|------|
| < 100ms | ✅ 優秀 | ユーザー体験良好 |
| 100ms - 500ms | ⚠️ 許容範囲 | 最適化を検討 |
| > 500ms | ❌ 遅い | 最適化が必要 |

### 95パーセンタイル

| P95 | 評価 | 説明 |
|-----|------|------|
| < 200ms | ✅ 優秀 | ほとんどのリクエストが高速 |
| 200ms - 1000ms | ⚠️ 許容範囲 | 一部のリクエストが遅い |
| > 1000ms | ❌ 遅い | 改善が必要 |

### スループット

| スループット | 評価 | 説明 |
|------------|------|------|
| > 10 req/sec | ✅ 優秀 | 十分な処理能力 |
| 5 - 10 req/sec | ⚠️ 許容範囲 | スケールアップを検討 |
| < 5 req/sec | ❌ 低い | スケーリングが必要 |

---

## Grafanaでの監視

### 推奨手順

1. **テスト開始前にGrafanaを開く**
   ```bash
   # Grafana URLを取得
   oc get route grafana -o jsonpath='{.spec.host}'
   ```

2. **推奨ダッシュボード**
   - Camel Comprehensive Dashboard

3. **監視すべきパネル**
   - **HTTP Request Rate** - リクエスト率の変化
   - **HTTP Response Time (95th percentile)** - レスポンスタイムの推移
   - **HTTP Error Rate** - エラー率の監視
   - **JVM Heap Memory Usage** - メモリ使用量
   - **GC Pause Time** - ガベージコレクションの影響
   - **Camel Exchanges Total** - Camelルートの処理数
   - **Undertow Worker Threads Busy** - スレッドプールの使用状況

4. **時間範囲の設定**
   - テスト開始時刻からテスト終了時刻まで
   - または「Last 30 minutes」など

---

## CSV結果のExcel分析

### 1. CSVファイルをExcelで開く

```bash
# 結果をCSVに出力
./stress_test_advanced.sh -m rampup -s 10 -e 100 -i 10 -d 60 -o results.csv
```

### 2. グラフを作成

#### スループットグラフ

- **X軸:** Concurrent（並列数）
- **Y軸:** Throughput（スループット）
- **グラフ種類:** 折れ線グラフ

#### レスポンスタイムグラフ

- **X軸:** Concurrent（並列数）
- **Y軸:** AvgTime, P95, P99
- **グラフ種類:** 折れ線グラフ（3系列）

#### エラー率グラフ

- **X軸:** Concurrent（並列数）
- **Y軸:** ErrorRate
- **グラフ種類:** 折れ線グラフ

### 3. 分析ポイント

1. **スループットの飽和点**
   - スループットが頭打ちになる並列数を確認
   - それ以上並列数を増やしても効果が薄い

2. **レスポンスタイムの増加**
   - レスポンスタイムが急激に増加する並列数を確認
   - システムのキャパシティ限界

3. **エラー率の上昇**
   - エラー率が上昇し始める並列数を確認
   - 許容できる最大負荷

---

## トラブルシューティング

### エラー率が高い

**症状:**
```
エラー率:           15.00%
```

**原因と対策:**

1. **リソース不足**
   ```bash
   # Podのリソース使用量を確認
   oc adm top pod -l app=camel-app
   
   # CPU/メモリのlimitsを増やす
   oc set resources deployment/camel-app \
     --limits=cpu=2,memory=2Gi \
     --requests=cpu=1,memory=1Gi
   ```

2. **レプリカ不足**
   ```bash
   # レプリカ数を増やす
   oc scale deployment/camel-app --replicas=3
   ```

3. **Kafkaの問題**
   ```bash
   # Kafkaログを確認
   oc logs -l app=kafka --tail=100
   ```

---

### レスポンスタイムが遅い

**症状:**
```
平均レスポンス:     850.00 ms
```

**原因と対策:**

1. **スレッドプール不足**
   - Undertow worker threadsを増やす
   - 環境変数で設定: `UNDERTOW_WORKER_THREADS=200`

2. **データベース接続プール**
   - 接続プールサイズを調整

3. **GCの影響**
   ```bash
   # GCログをGrafanaで確認
   # JVM GC Pause Time パネル
   ```

---

### スループットが低い

**症状:**
```
スループット:       3.50 req/sec
```

**原因と対策:**

1. **水平スケーリング**
   ```bash
   oc scale deployment/camel-app --replicas=5
   ```

2. **垂直スケーリング**
   ```bash
   # CPU/メモリを増やす
   oc set resources deployment/camel-app \
     --limits=cpu=4,memory=4Gi \
     --requests=cpu=2,memory=2Gi
   ```

3. **ボトルネックの特定**
   - Grafana Tempoでトレースを分析
   - 最も時間がかかっている処理を特定

---

## ベストプラクティス

### 1. テスト前の準備

- ✅ Grafanaダッシュボードを開く
- ✅ アプリケーションが健全な状態か確認
- ✅ 他の負荷がかかっていないか確認
- ✅ 十分なKafkaストレージがあるか確認

### 2. テストの実施

- ✅ 軽い負荷から始める（lightプリセット）
- ✅ 段階的に負荷を上げる（rampupモード）
- ✅ 各テスト後に結果を確認
- ✅ 異常が見られたら中断（Ctrl+C）

### 3. テスト後の確認

- ✅ Grafanaでメトリクスを確認
- ✅ Lokiでエラーログを確認
- ✅ Tempoでトレースを分析
- ✅ 結果をCSVに保存して分析

### 4. 推奨テストシナリオ

**ステップ1: 初回テスト（軽負荷）**
```bash
./stress_test_advanced.sh -m preset -p light -o test1-light.csv
```

**ステップ2: 中負荷テスト**
```bash
./stress_test_advanced.sh -m preset -p medium -o test2-medium.csv
```

**ステップ3: 限界テスト**
```bash
./stress_test_advanced.sh -m preset -p heavy -o test3-heavy.csv
```

**ステップ4: 最適値の特定**
```bash
# ステップ1-3の結果から最適範囲を特定
# 例: 30-60並列が最適と判明した場合
./stress_test_advanced.sh -m rampup -s 30 -e 60 -i 5 -d 120 -o test4-optimal.csv
```

---

## まとめ

### スクリプト比較

| 機能 | stress_test.sh | stress_test_advanced.sh |
|------|---------------|------------------------|
| 単一テスト | ✅ | ✅ |
| ランプアップ | ❌ | ✅ |
| 複数設定テスト | ❌ | ✅ |
| プリセット | ❌ | ✅ |
| 結果比較 | ❌ | ✅ |
| CSV出力 | ❌ | ✅ |

### 使い分け

- **stress_test.sh**: クイックテスト、単発確認
- **stress_test_advanced.sh**: 詳細分析、最適化、ベンチマーク

---

## 関連ドキュメント

- [STRESS_TEST_GUIDE.md](STRESS_TEST_GUIDE.md) - 基本的なストレステストガイド
- [GRAFANA_SETUP.md](../GRAFANA_SETUP.md) - Grafana監視設定
- [UNDERTOW_DASHBOARD_README.md](UNDERTOW_DASHBOARD_README.md) - Undertowメトリクス
- [OPENSHIFT_DEPLOYMENT_GUIDE.md](OPENSHIFT_DEPLOYMENT_GUIDE.md) - デプロイメントガイド


