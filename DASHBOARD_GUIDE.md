# 📊 Grafanaダッシュボード利用ガイド

## 🎯 ダッシュボード概要

このプロジェクトには、2つのGrafanaダッシュボードが自動プロビジョニングされています：

### 1. **Camel Observability Dashboard** (基本版)
- **UID:** `camel-observability`
- **目的:** オブザーバビリティの基本を学ぶ
- **パネル数:** 4パネル
- **推奨用途:** チュートリアル、デモ

### 2. **Camel + Kafka + SpringBoot 分散アプリケーション ダッシュボード** (包括版) ⭐
- **UID:** `camel-comprehensive`
- **目的:** 本番運用レベルの監視
- **パネル数:** 17パネル
- **推奨用途:** 開発、本番監視、パフォーマンスチューニング

---

## 🚀 ダッシュボードへのアクセス

### ステップ1: Grafanaにログイン

1. ブラウザで http://localhost:3000 を開く
2. ユーザー名: `admin`
3. パスワード: `admin`
4. 初回ログイン時、パスワード変更をスキップ可能

### ステップ2: ダッシュボードを開く

#### 方法A: メニューから選択
1. 左メニュー → **「Dashboards」** をクリック
2. ダッシュボード一覧が表示される
3. **「Camel + Kafka + SpringBoot 分散アプリケーション ダッシュボード」** をクリック

#### 方法B: 検索から開く
1. 上部の検索バー（虫眼鏡アイコン）をクリック
2. 「camel」と入力
3. 候補から選択

#### 方法C: 直接URLアクセス
```
http://localhost:3000/d/camel-comprehensive
```

---

## 📊 包括版ダッシュボード詳細解説

### Row 1: 📊 システム概要

#### 1. ⏱️ アプリケーション稼働時間
- **メトリクス:** `process_uptime_seconds`
- **単位:** 秒
- **用途:** アプリケーションの再起動を検知
- **正常値:** 連続して増加
- **異常パターン:** 突然ゼロにリセット（再起動発生）

#### 2. 💻 CPU使用率
- **メトリクス:** `process_cpu_usage * 100`
- **単位:** パーセント
- **閾値:**
  - 🟢 緑: 0-50% (正常)
  - 🟡 黄: 50-70% (注意)
  - 🟠 橙: 70-85% (警告)
  - 🔴 赤: 85-100% (危険)
- **用途:** CPU負荷の監視
- **異常パターン:** 常に80%以上（スレッドブロッキング、無限ループの可能性）

#### 3. 🧠 ヒープメモリ使用率
- **メトリクス:** `(jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) * 100`
- **単位:** パーセント
- **閾値:**
  - 🟢 緑: 0-60% (正常)
  - 🟡 黄: 60-80% (注意)
  - 🟠 橙: 80-90% (警告)
  - 🔴 赤: 90-100% (危険、OOMリスク)
- **用途:** メモリリーク検知、OOM予防
- **異常パターン:** 継続的に上昇し続ける（メモリリーク）

#### 4. 🧵 アクティブスレッド数
- **メトリクス:** `jvm_threads_live_threads`
- **単位:** 個
- **閾値:**
  - 🟢 緑: 0-50 (正常)
  - 🟡 黄: 50-80 (注意)
  - 🟠 橙: 80-100 (警告)
  - 🔴 赤: 100+ (危険、スレッドリーク)
- **用途:** スレッドリーク検知
- **異常パターン:** 継続的に増加し続ける（スレッドリーク）

---

### Row 2: 🐫 Camel ルート パフォーマンス

#### 5. 📨 メッセージ処理レート
- **メトリクス:** 
  - `rate(camel_exchanges_total[1m])` (総処理数)
  - `rate(camel_exchanges_succeeded_total[1m])` (成功数)
  - `rate(camel_exchanges_failed_total[1m])` (失敗数)
- **単位:** ops (operations per second)
- **用途:** 
  - スループット監視
  - ルート別のトラフィック分析
  - 成功/失敗のバランス確認
- **正常値:** 成功数 >> 失敗数
- **異常パターン:** 
  - 処理レートが急激にゼロになる（ルート停止）
  - 失敗数が成功数を上回る（深刻な問題）

#### 6. ❌ エラー率
- **メトリクス:** `(rate(camel_exchanges_failed_total[1m]) / rate(camel_exchanges_total[1m])) * 100`
- **単位:** パーセント
- **閾値:**
  - 🟢 緑: 0-1% (正常)
  - 🟡 黄: 1-5% (注意)
  - 🟠 橙: 5-10% (警告)
  - 🔴 赤: 10%+ (危険)
- **用途:** システムの健全性を一目で把握
- **異常パターン:** エラー率が5%超え（要調査）

#### 7. ⏱️ 平均処理時間
- **メトリクス:** `rate(camel_route_policy_seconds_sum[1m]) / rate(camel_route_policy_seconds_count[1m])`
- **単位:** 秒
- **用途:** 
  - ボトルネックの特定
  - パフォーマンス劣化の検知
  - SLA達成確認
- **正常値:** 安定した値（本デモでは0.2-0.5秒が正常）
- **異常パターン:** 
  - 処理時間が急激に増加（ボトルネック発生）
  - 特定のルートだけ遅い（そのルートに問題）

#### 8. 📊 処理中メッセージ数（Inflight）
- **メトリクス:** `camel_exchanges_inflight`
- **単位:** 個
- **閾値:**
  - 🟢 緑: 0-50 (正常)
  - 🟡 黄: 50-100 (注意)
  - 🟠 橙: 100-200 (警告)
  - 🔴 赤: 200+ (危険、処理が追いついていない)
- **用途:** 
  - バックプレッシャーの検知
  - 処理の滞留監視
- **異常パターン:** 
  - 常に高い値（処理速度 < 受信速度）
  - 急激に増加（一時的なバースト）

#### 9. 🚦 実行中ルート数
- **メトリクス:** `camel_routes_running_routes`
- **単位:** 個
- **用途:** 
  - ルートの起動状態確認
  - 意図しない停止の検知
- **正常値:** 期待されるルート数（本デモでは4-5ルート）
- **異常パターン:** 
  - 期待値より少ない（ルートが停止している）
  - ゼロ（全ルート停止、重大障害）

---

### Row 3: 🌐 HTTP エンドポイント

#### 10. 📡 HTTPリクエストレート（エンドポイント別）
- **メトリクス:** `sum by (uri) (rate(http_server_requests_seconds_count[1m]))`
- **単位:** reqps (requests per second)
- **用途:** 
  - エンドポイント別のトラフィック分析
  - ホットパスの特定
  - 異常なトラフィックスパイクの検知
- **表示形式:** 積み上げグラフ
- **異常パターン:** 
  - 特定のエンドポイントへのトラフィック急増（攻撃の可能性）

#### 11. ⏰ HTTPレスポンスタイム
- **メトリクス:** 
  - `rate(http_server_requests_seconds_sum[1m]) / rate(http_server_requests_seconds_count[1m])` (平均)
  - `http_server_requests_seconds_max` (最大)
- **単位:** 秒
- **用途:** 
  - APIパフォーマンス監視
  - SLA達成確認
  - レイテンシ劣化の検知
- **異常パターン:** 
  - 平均時間が1秒超え（遅い）
  - 最大時間が極端に長い（タイムアウト発生の可能性）

#### 12. 🚨 HTTPステータスコード別レート
- **メトリクス:** `sum by (status) (rate(http_server_requests_seconds_count[1m]))`
- **単位:** reqps
- **色分け:**
  - 🟢 緑: 2xx (成功)
  - 🟠 橙: 4xx (クライアントエラー)
  - 🔴 赤: 5xx (サーバーエラー)
- **用途:** 
  - エラー発生状況の監視
  - 異常なエラーパターンの検知
- **正常値:** 2xxが大半
- **異常パターン:** 
  - 5xxが多い（サーバー側問題）
  - 4xxが急増（不正アクセスの可能性）

---

### Row 4: 🧠 JVM メモリ詳細

#### 13. 💾 ヒープメモリ使用量推移
- **メトリクス:** 
  - `jvm_memory_used_bytes{area="heap"}` (使用中)
  - `jvm_memory_committed_bytes{area="heap"}` (コミット済み)
  - `jvm_memory_max_bytes{area="heap"}` (最大)
- **単位:** バイト
- **用途:** 
  - メモリ使用パターンの分析
  - メモリリーク検知
  - GC動作の理解
- **正常パターン:** 
  - 鋸歯状のグラフ（メモリ増加 → GC実行 → メモリ減少）
- **異常パターン:** 
  - 継続的に上昇（メモリリーク）
  - GC後もメモリが減らない（深刻なメモリリーク）

#### 14. 🗑️ ガベージコレクション
- **メトリクス:** 
  - `rate(jvm_gc_pause_seconds_count[1m]) * 60` (GC実行頻度)
  - `rate(jvm_gc_pause_seconds_sum[1m]) / rate(jvm_gc_pause_seconds_count[1m])` (GC平均時間)
- **単位:** 回/分、秒
- **用途:** 
  - GCパフォーマンス監視
  - メモリ不足の兆候検知
- **正常値:** 
  - 頻度: 1-10回/分
  - 平均時間: 0.01-0.1秒
- **異常パターン:** 
  - GC頻度が極端に高い（メモリ不足）
  - GC時間が長い（フルGCが頻発）

#### 15. 📦 メモリ割り当てレート
- **メトリクス:** 
  - `rate(jvm_gc_memory_allocated_bytes_total[1m])` (割り当てレート)
  - `rate(jvm_gc_memory_promoted_bytes_total[1m])` (昇格レート)
- **単位:** Bps (bytes per second)
- **用途:** 
  - アプリケーションのメモリ消費速度を把握
  - 世代別GCの動作理解
- **異常パターン:** 
  - 割り当てレートが異常に高い（無駄なオブジェクト生成）
  - 昇格レートが高い（長生きオブジェクトが多い）

#### 16. ⚠️ GCオーバーヘッド率
- **メトリクス:** `jvm_gc_overhead_percent`
- **単位:** パーセント
- **閾値:**
  - 🟢 緑: 0-5% (正常)
  - 🟡 黄: 5-10% (注意)
  - 🟠 橙: 10-20% (警告)
  - 🔴 赤: 20%+ (危険、ヒープサイズ不足)
- **用途:** GCがアプリケーションに与える影響を把握
- **異常パターン:** 10%超え（ヒープサイズの増加が必要）

---

### Row 5: 📊 メッセージフロー全体

#### 17. 🔄 エンドツーエンド メッセージフロー
- **メトリクス:** 
  1. `rate(http_server_requests_seconds_count{uri="/camel/api/orders"}[1m])` (HTTP POST)
  2. `rate(camel_exchanges_total{routeId="order-producer-route"}[1m])` (Producer → Kafka)
  3. `rate(camel_exchanges_total{routeId="order-consumer-route"}[1m])` (Kafka → Consumer)
  4. `rate(camel_exchanges_succeeded_total{routeId="order-consumer-route"}[1m])` (Success)
  5. `rate(camel_exchanges_failed_total{routeId="order-consumer-route"}[1m])` (Failed)
- **単位:** ops
- **用途:** 
  - システム全体のメッセージフローを一目で把握
  - ボトルネックの特定
  - データの流れの健全性確認
- **正常パターン:** 
  - 1 ≈ 2 ≈ 3 (HTTPリクエスト → Kafka → 処理)
  - 4 >> 5 (成功 >> 失敗)
- **異常パターン:** 
  - 1 > 2 (Kafkaへの送信が失敗)
  - 2 > 3 (Kafkaから消費できていない、ラグ発生)
  - 5 が多い (処理エラーが頻発)

---

## 🎯 使い方のベストプラクティス

### 1. 日常監視
- **システム概要Row**を常時監視
- CPU、メモリ、スレッドが正常範囲内か確認
- 異常があれば詳細Rowを確認

### 2. パフォーマンスチューニング
- **Camelルートパフォーマンス**で遅いルートを特定
- **HTTPレスポンスタイム**で遅いエンドポイントを特定
- **JVMメモリ詳細**でGCチューニングの必要性を判断

### 3. 障害調査
1. **メッセージフロー全体**でどこでデータが止まっているか確認
2. **エラー率**で影響範囲を把握
3. **HTTPステータスコード別レート**でエラーの種類を確認
4. Tempoでトレースを確認（詳細な処理フロー）
5. Lokiでログを確認（エラーの詳細）

### 4. 負荷テスト時
1. 負荷テスト実行前にダッシュボードを開く
2. 時間範囲を「Last 15 minutes」に設定
3. すべてのメトリクスを同時に監視
4. ボトルネックとなるメトリクスを特定

---

## 🔍 よくある質問

### Q1: ダッシュボードにデータが表示されない
**A:** 以下を確認：
1. アプリケーションが起動しているか
2. Prometheusが正常に動作しているか
3. メトリクスエンドポイントが応答しているか
   ```bash
   curl http://localhost:8080/actuator/prometheus
   ```

### Q2: 一部のパネルだけデータがない
**A:** そのメトリクスが生成されていない可能性があります：
- Camelルートが起動していない
- 該当の処理が実行されていない
- メトリクス名が変更されている

### Q3: ダッシュボードをカスタマイズしたい
**A:** 
1. パネル右上の「...」→「Edit」をクリック
2. クエリを編集
3. 保存（右上の「Save dashboard」）

### Q4: 時間範囲を変更したい
**A:** 右上の時間範囲選択ドロップダウンから選択
- Last 5 minutes（デフォルト）
- Last 15 minutes
- Last 1 hour
- Custom range

---

## 📚 関連ドキュメント

- **[METRICS_GUIDE.md](METRICS_GUIDE.md)** - メトリクス詳細ガイド
- **[OBSERVABILITY_EXPERIENCE.md](OBSERVABILITY_EXPERIENCE.md)** - オブザーバビリティ体験ガイド
- **[GRAFANA_HOWTO.md](GRAFANA_HOWTO.md)** - Grafana基本操作

---

## 🎉 まとめ

このダッシュボードは、SpringBoot + Camel + Kafkaの分散アプリケーションを包括的に監視するために設計されています。

**17のパネル**が、システムの健全性、パフォーマンス、エラー状況を多角的に可視化します。

日常監視から障害調査、パフォーマンスチューニングまで、あらゆるシーンで活用できます！🚀




