# ワーカースレッド1での極限キューテスト

## 🎯 **目的**

ワーカースレッド数を**1**に設定することで、確実にキューイングを発生させる。

---

## ⚠️ **重要な警告**

### ワーカースレッド1の影響

```
ワーカースレッド: 1
並列リクエスト: 100
→ 99件がキューに待機
→ 1件ずつ順次処理

結果:
  - レスポンスタイムが極端に長くなる（数秒〜数十秒）
  - スループットが極めて低下する（1-5 req/s）
  - キューイングが常時発生する
  - アプリケーションがほぼ応答不能になる
```

### ⚠️ 使用上の注意

- **テスト環境専用**
- **本番環境では絶対に使用禁止**
- **テスト後は必ず元に戻す（200スレッド）**

---

## 🚀 **ワーカースレッド1への変更方法**

### ステップ1: 設定変更

```bash
cd /Users/kjin/mobills/observability/demo

./change-worker-threads.sh
```

**選択:**
```
変更オプション:
  1) 1スレッド   (キューテスト用 - 確実にキュー発生)  ← これを選択
  2) 5スレッド   (キューテスト用 - 推奨)
  3) 10スレッド  (キューテスト用)
  4) 20スレッド  (中負荷テスト用)
  5) 50スレッド  (通常負荷)
  6) 200スレッド (デフォルト - 本番用)
  7) カスタム値
  0) キャンセル

選択してください [1-7, 0]: 1
```

**警告が表示されます:**
```
⚠⚠⚠ 警告 - ワーカースレッド1 ⚠⚠⚠
  ワーカースレッドが1つだけのため、以下の影響があります:
  - レスポンスタイムが極端に長くなります
  - スループットが極めて低下します
  - キューイングが常時発生します
  - アプリケーションがほぼ応答不能になります

✓ キューサイズテスト専用です
✓ テスト後は必ず元に戻してください
```

**続行:**
```
変更を適用しますか? (y/n): y
今すぐ再起動しますか? (y/n): y
```

---

## 📊 **テスト実行**

### 方法1: 既存のストレステスト（推奨）

```bash
./load-test-stress.sh
```

**期待される結果:**
```
並列数: 5-100（段階的）
ワーカー: 1

Queue Size: 4-99（段階的に増加）
Active Requests: 1（常に1）
Worker Usage: 100%（常にフル稼働）
```

### 方法2: 極限負荷テスト

```bash
./load-test-extreme-queue.sh
```

**期待される結果:**
```
並列数: 100
ワーカー: 1

Queue Size: 99（ほぼ満杯）
Active Requests: 1（常に1）
Worker Usage: 100%（常にフル稼働）

レスポンスタイム: 5-30秒（非常に遅い）
```

### 方法3: 少数の並列リクエストでもキューが発生

```bash
# たった10並列でもキューが発生
for i in {1..10}; do
  curl -X POST http://localhost:8080/camel/api/orders \
    -H "Content-Type: application/json" \
    -d '{"id": "ORD-'$i'", "product": "Test", "quantity": 1, "price": 100}' &
done

# すぐにメトリクスを確認
curl -s http://localhost:8080/actuator/prometheus | grep "^undertow"
```

**期待される結果:**
```
undertow_worker_threads: 1.0
undertow_request_queue_size: 9.0  ← 10リクエスト中9件がキュー
undertow_active_requests: 1.0     ← 1件のみ処理中
```

---

## 📈 **リアルタイム監視**

### ターミナル1: テスト実行

```bash
./load-test-stress.sh
```

### ターミナル2: リアルタイム監視

```bash
./watch-queue-size.sh
```

**期待される表示:**
```
時刻       | Queue Size   | Active Req   | Workers      | Usage %     
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
11:30:01   | 0.0          | 0.0          | 1.0          | 0.0         
11:30:02   | 4.0          | 1.0          | 1.0          | 100.0       ← キュー発生
11:30:03   | 9.0          | 1.0          | 1.0          | 100.0       
11:30:04   | 19.0         | 1.0          | 1.0          | 100.0       
11:30:05   | 49.0         | 1.0          | 1.0          | 100.0       
11:30:06   | 99.0         | 1.0          | 1.0          | 100.0       ← ほぼ満杯
11:30:07   | 95.0         | 1.0          | 1.0          | 100.0       
11:30:08   | 87.0         | 1.0          | 1.0          | 100.0       
```

---

## 📊 **期待されるメトリクス**

### ワーカースレッド1の場合

| テスト負荷 | Queue Size | Active Requests | Worker Usage | レスポンスタイム |
|---|---|---|---|---|
| **10並列** | 9 | 1 | 100% | 1-3秒 |
| **20並列** | 19 | 1 | 100% | 2-6秒 |
| **50並列** | 49 | 1 | 100% | 5-15秒 |
| **100並列** | 99 | 1 | 100% | 10-30秒 |

### 比較: ワーカースレッド5の場合

| テスト負荷 | Queue Size | Active Requests | Worker Usage | レスポンスタイム |
|---|---|---|---|---|
| **10並列** | 0-5 | 5 | 100% | 0.1-0.5秒 |
| **20並列** | 10-15 | 5 | 100% | 0.2-1秒 |
| **50並列** | 40-45 | 5 | 100% | 0.5-2秒 |
| **100並列** | 90-95 | 5 | 100% | 1-5秒 |

**結論**: ワーカースレッド1では、**どんな負荷でも確実にキューが発生**します。

---

## 🎯 **ワーカースレッド数による違い**

### ワーカー1 vs ワーカー5 vs ワーカー200

| ワーカー数 | 10並列リクエスト | 100並列リクエスト | キュー発生 |
|---|---|---|---|
| **1** | Queue: 9 | Queue: 99 | ✅ 常時発生 |
| **5** | Queue: 0-5 | Queue: 90-95 | ✅ 発生 |
| **200** | Queue: 0 | Queue: 0 | ❌ 発生しない |

---

## 🔄 **元に戻す方法**

### ⚠️ テスト完了後は必ず実行

```bash
./change-worker-threads.sh
```

**選択:**
```
選択してください [1-7, 0]: 6  ← 200スレッド（デフォルト）
```

**または:**
```
選択してください [1-7, 0]: 2  ← 5スレッド（キューテスト用）
```

---

## 🧪 **実験: 最小負荷でキューを発生させる**

### 2並列リクエストでもキュー発生

```bash
# たった2つのリクエスト
curl -X POST http://localhost:8080/camel/api/orders \
  -H "Content-Type: application/json" \
  -d '{"id": "ORD-1", "product": "Test1", "quantity": 1}' &

curl -X POST http://localhost:8080/camel/api/orders \
  -H "Content-Type: application/json" \
  -d '{"id": "ORD-2", "product": "Test2", "quantity": 1}' &

# すぐに確認
curl -s http://localhost:8080/actuator/prometheus | grep undertow
```

**結果:**
```
undertow_worker_threads: 1.0
undertow_request_queue_size: 1.0  ← 2リクエスト中1件がキュー
undertow_active_requests: 1.0
```

**解説:**
- リクエスト1: ワーカーで処理中
- リクエスト2: キューで待機中

**ワーカースレッド1では、2つ以上の同時リクエストで必ずキューイングが発生します。**

---

## 📊 **Grafanaでの確認**

### ダッシュボード表示

```
http://localhost:3000
→ Undertow Monitoring Dashboard
```

**確認するパネル:**

1. **⭐ Undertow Queue Size**
   - 値: 5-99
   - 色: 赤（閾値超過）

2. **Undertow Active Requests**
   - 値: 1（固定）
   - 常に1件のみ処理

3. **Undertow Worker Usage (%)**
   - 値: 100%（固定）
   - 常にフル稼働

4. **⭐ Queue Size (Time Series)**
   - グラフ: 右肩上がり
   - ピーク: 99

---

## 💡 **ワーカースレッド1が有効なケース**

### ✅ 推奨される用途

1. **キューサイズメトリクスのテスト**
   - 確実にキューを発生させたい
   - メトリクスが正しく動作するか確認

2. **アラート設定のテスト**
   - キューサイズアラートが発火するか確認
   - アラート閾値の調整

3. **極限状態のシミュレーション**
   - システムが限界状態でどう動作するか確認
   - ボトルネック分析

4. **デモ・プレゼンテーション**
   - キューイングの様子を視覚的に示す
   - オブザーバビリティツールのデモ

### ❌ 非推奨・禁止

- **本番環境での使用** - 絶対禁止
- **長時間の運用** - テストのみ
- **実際の負荷テスト** - 非現実的
- **パフォーマンス評価** - 正確な評価不可

---

## 📋 **チェックリスト**

### テスト前

- [ ] テスト環境であることを確認
- [ ] 他のユーザーがアクセスしていないことを確認
- [ ] バックアップ設定ファイルがあることを確認

### テスト中

- [ ] ワーカースレッド数を1に設定
- [ ] アプリケーションを再起動
- [ ] 負荷テストを実行
- [ ] メトリクスをリアルタイム監視
- [ ] Grafanaで視覚的に確認

### テスト後

- [ ] ワーカースレッド数を200に戻す
- [ ] アプリケーションを再起動
- [ ] 正常に動作することを確認
- [ ] メトリクスが正常値に戻ったことを確認

---

## 🎉 **まとめ**

### ワーカースレッド1の特徴

| 項目 | 評価 |
|---|---|
| **キュー発生確率** | ⭐⭐⭐⭐⭐ 100% |
| **テスト容易性** | ⭐⭐⭐⭐⭐ 非常に簡単 |
| **実用性** | ⭐ テスト専用 |
| **危険性** | ⭐⭐⭐⭐⭐ 非常に高い |

### 推奨設定

| 用途 | ワーカー数 | 理由 |
|---|---|---|
| **確実なキューテスト** | 1 | どんな負荷でもキュー発生 |
| **一般的なキューテスト** | 5 | 適度な負荷でキュー発生 |
| **本番環境** | 200 | 高パフォーマンス |

---

**作成日**: 2025-10-20  
**トピック**: ワーカースレッド1での極限キューテスト  
**結論**: ワーカースレッド1は確実にキューを発生させる最強の設定


